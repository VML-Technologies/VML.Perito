---
description:
globs:
alwaysApply: false
---

# Manejo de Errores y Diagnóstico

## Errores Comunes de Base de Datos

### 1. Errores de Conexión en Scripts de Seeding

- **Error**: `ConnectionRefusedError` en scripts pero el servidor funciona
- **Causa**: Variables de entorno no se cargan correctamente en scripts
- **Solución**: Usar ruta explícita en dotenv.config()

```javascript
// ❌ Incorrecto
dotenv.config();

// ✅ Correcto
import path from 'path';
import { fileURLToPath } from 'url';
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
dotenv.config({ path: path.join(__dirname, '../.env') });
```

### 2. Errores de Llaves Foráneas

- **Error**: `ER_NO_REFERENCED_ROW_2` al crear registros
- **Causa**: Intentar crear registros que referencian IDs inexistentes
- **Solución**: Verificar orden de seeding - crear tablas referenciadas primero

Orden correcto para [apps/server/scripts/seedAll.js](mdc:apps/server/scripts/seedAll.js):

1. RBAC (roles y permisos)
2. Datos básicos (departamentos, ciudades, empresas, sedes)
3. Usuarios (requieren sede_id válido)
4. Datos de inspección
5. Usuarios con roles específicos

## Proceso de Diagnóstico

### Para Errores de Base de Datos

1. Verificar estructura de tablas
2. Revisar modelos Sequelize
3. Ejecutar migraciones si es necesario
4. Confirmar sincronización de modelos

### Para Errores de API

1. Verificar endpoints en [apps/server/index.js](mdc:apps/server/index.js)
2. Revisar controladores correspondientes
3. Validar middleware de autenticación
4. Confirmar rutas en [apps/web/src/config/api.js](mdc:apps/web/src/config/api.js)

### Para Errores de Frontend

1. Revisar componentes React
2. Validar contexto de autenticación
3. Verificar llamadas a API
4. Confirmar manejo de estados

## Comandos de Diagnóstico Útiles

```bash
# Verificar estructura de tabla
cd apps/server && node -e "const { sequelize } = require('./models'); sequelize.query('DESCRIBE inspection_orders').then(result => console.table(result[0]));"

# Probar endpoint simple
curl http://192.168.20.6:3000/api/test

# Verificar modelo
curl http://192.168.20.6:3000/api/inspection-orders-simple
```

## Archivos de Configuración Clave

- Base de datos: [apps/server/config/database.js](mdc:apps/server/config/database.js)
- Modelos: [apps/server/models/index.js](mdc:apps/server/models/index.js)
- Controlador: [apps/server/controllers/inspectionOrderController.js](mdc:apps/server/controllers/inspectionOrderController.js)
