---
alwaysApply: true
---
# Sistema RBAC - VML.Perito

## Arquitectura del Sistema

### Modelos de Datos
- [apps/server/models/user.js](mdc:apps/server/models/user.js) - Usuario con relaciones a roles
- [apps/server/models/role.js](mdc:apps/server/models/role.js) - Roles del sistema
- [apps/server/models/permission.js](mdc:apps/server/models/permission.js) - Permisos granulares
- [apps/server/models/userRole.js](mdc:apps/server/models/userRole.js) - Tabla pivote usuario-rol
- [apps/server/models/rolePermission.js](mdc:apps/server/models/rolePermission.js) - Tabla pivote rol-permiso

### Middleware de Autorización
- [apps/server/middleware/rbac.js](mdc:apps/server/middleware/rbac.js) - Middleware `requirePermission()`

### Controladores RBAC
- [apps/server/controllers/roleController.js](mdc:apps/server/controllers/roleController.js) - Gestión de roles
- [apps/server/controllers/permissionController.js](mdc:apps/server/controllers/permissionController.js) - Gestión de permisos

## Patrones de Uso en Backend

### 1. Proteger Rutas con Permisos
```javascript
import { requirePermission } from './middleware/rbac.js';

// Proteger una ruta específica
app.get('/api/users', requirePermission('users.read'), userController.index);
app.post('/api/users', requirePermission('users.create'), userController.store);
app.put('/api/users/:id', requirePermission('users.update'), userController.update);
app.delete('/api/users/:id', requirePermission('users.delete'), userController.destroy);
```

### 2. Verificar Permisos en Controladores
```javascript
// El middleware agrega req.user con roles y permisos
async profile(req, res) {
    const user = req.user; // Usuario autenticado con roles/permisos
    // Lógica del controlador
}
```

### 3. Estructura de Permisos
Los permisos siguen el patrón: `recurso.accion`
- `users.read` - Ver usuarios
- `users.create` - Crear usuarios
- `users.update` - Actualizar usuarios
- `users.delete` - Eliminar usuarios
- `roles.read` - Ver roles
- `permissions.read` - Ver permisos

## Patrones de Uso en Frontend

### 1. Contexto RBAC
```javascript
// Usar el contexto RBAC
import { useRBAC } from './contexts/rbac-context.jsx';

function MyComponent() {
    const { hasPermission, hasRole, userPermissions } = useRBAC();
    
    if (hasPermission('users.read')) {
        // Mostrar contenido
    }
}
```

### 2. Componente PermissionGate
```javascript
import PermissionGate from './components/PermissionGate.jsx';

// Renderizar condicionalmente basado en permisos
<PermissionGate permission="users.create">
    <CreateUserButton />
</PermissionGate>

// Múltiples permisos (OR)
<PermissionGate permissions={['users.read', 'admin.read']}>
    <UsersList />
</PermissionGate>

// Múltiples permisos (AND)
<PermissionGate permissions={['users.read', 'users.update']} requireAll>
    <EditUserForm />
</PermissionGate>
```

### 3. Rutas Protegidas
```javascript
import ProtectedRoute from './components/protected-route.jsx';

// Proteger rutas completas
<Route path="/admin" element={
    <ProtectedRoute permission="admin.read">
        <AdminPanel />
    </ProtectedRoute>
} />
```

## Roles Predefinidos

### super_admin
- Acceso completo al sistema
- Puede gestionar usuarios, roles y permisos
- Acceso a todas las funcionalidades

### admin
- Gestión de usuarios y contenido
- Acceso limitado a configuración del sistema

### comercial_mundial
- Crear y gestionar órdenes de inspección
- Permisos: `inspection_orders.*`

### coordinador_contacto
- Asignar agentes a órdenes de inspección
- Ver estadísticas del centro de contacto
- Permisos: `coordinador_contacto.*`

### agente_contacto
- Gestionar llamadas y agendamientos
- Manejar órdenes asignadas
- Permisos: `contact_agent.*`

### user
- Acceso básico a funcionalidades principales
- Sin permisos administrativos

## Mejores Prácticas

### 1. Principio de Menor Privilegio
- Asignar solo los permisos mínimos necesarios
- Revisar regularmente los permisos asignados
- Usar roles específicos en lugar de super_admin cuando sea posible

### 2. Naming Convention para Permisos
```
recurso.accion
├── users.read
├── users.create
├── users.update
├── users.delete
├── roles.read
├── roles.create
├── documents.read
└── system.read
```

### 3. Verificación en Múltiples Capas
- **Frontend**: PermissionGate para UX
- **Backend**: requirePermission middleware para seguridad
- **Base de Datos**: Constraints y validaciones

### 4. Manejo de Errores
```javascript
// El middleware RBAC retorna errores estándar
// 401: Token requerido o inválido
// 403: Sin permisos para la acción
// 500: Error interno de autorización
```

## Extensión del Sistema

### 1. Agregar Nuevos Permisos
```javascript
// En el seeder o migración
await Permission.create({
    name: 'documents.read',
    description: 'Ver documentos',
    resource: 'documents',
    action: 'read'
});
```

### 2. Crear Nuevos Roles
```javascript
// Crear rol con permisos específicos
const role = await Role.create({
    name: 'editor',
    description: 'Editor de contenido'
});

await role.setPermissions([
    'documents.read',
    'documents.create',
    'documents.update'
]);
```

### 3. Asignar Roles a Usuarios
```javascript
// En controladores
await user.setRoles([roleId1, roleId2]);

// O usando el controlador RBAC
POST /api/users/:userId/roles
{
    "roles": [1, 2, 3]
}
```

## WebSockets y RBAC

El sistema WebSocket integra automáticamente RBAC:

```javascript
// En socketManager.js - verificación automática
socket.userPermissions // Array de permisos del usuario
socket.userRoles // Array de roles del usuario

// Verificación en eventos WebSocket
if (socket.userPermissions.includes('users.read')) {
    // Permitir acción
}
```

## Debugging y Monitoreo

### 1. Logs de Autorización
El middleware RBAC registra automáticamente:
- Intentos de acceso denegados
- Tokens inválidos
- Errores de autorización

### 2. Endpoints de Diagnóstico
```bash
# Ver roles y permisos (requiere permisos)
GET /api/roles
GET /api/permissions
GET /api/users/with-roles
```

### 3. Verificación Manual
```javascript
// En cualquier controlador
console.log('Usuario:', req.user.name);
console.log('Roles:', req.user.roles);
console.log('Permisos:', req.user.permissions);
```
