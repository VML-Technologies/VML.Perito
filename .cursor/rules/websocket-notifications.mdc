# WebSocket y Sistema de Notificaciones

## Arquitectura de Notificaciones

- **Backend**: Servicios en [services/](mdc:apps/server/services/) para envío de notificaciones
- **WebSocket**: Manejo en [websocket/](mdc:apps/server/websocket/) para tiempo real
- **Frontend**: Hooks en [hooks/](mdc:apps/web/src/hooks/) para consumo de notificaciones

## Tipos de Notificaciones

- **Sistema**: Notificaciones internas del sistema
- **Email**: Notificaciones por correo electrónico
- **SMS**: Notificaciones por mensaje de texto
- **WhatsApp**: Notificaciones por WhatsApp
- **Push**: Notificaciones push del navegador

## Configuración de Notificaciones

- Usar [notificationConfig.js](mdc:apps/server/models/notificationConfig.js) para configuración
- Definir plantillas en `template_title` y `template_content`
- Configurar canales activos por tipo de notificación
- Usar variables dinámicas con sintaxis `{{variable}}`

## WebSocket - Backend

- Usar [socketManager.js](mdc:apps/server/websocket/socketManager.js) para gestión de conexiones
- Implementar [notificationHandler.js](mdc:apps/server/websocket/notificationHandler.js) para envío
- Emitir eventos específicos por tipo de notificación
- Mantener estado de conexión de usuarios

## WebSocket - Frontend

- Usar [use-websocket.js](mdc:apps/web/src/hooks/use-websocket.js) para conexión
- Implementar [use-notifications.js](mdc:apps/web/src/hooks/use-notifications.js) para gestión
- Manejar reconexión automática en caso de desconexión
- Mostrar indicador de estado de conexión

## Patrones de Implementación

```javascript
// Backend - Emitir notificación
webSocketSystem.sendToUser(userId, 'order_assigned', {
  type: 'asignacion_orden',
  order_id: orderId,
  message: 'Te han asignado una nueva orden',
});

// Frontend - Escuchar notificaciones
const { notifications, markAsRead } = useNotifications();
```

## Eventos WebSocket Principales

- `order_assigned`: Nueva orden asignada
- `order_removed`: Orden removida de asignación
- `call_logged`: Nueva llamada registrada
- `appointment_scheduled`: Agendamiento realizado
- `status_updated`: Estado de orden actualizado

## Buenas Prácticas

- Usar `NotificationProvider` en lugar de alerts del navegador
- Implementar notificaciones persistentes en BD
- Manejar errores de conexión WebSocket
- Limpiar notificaciones antiguas automáticamente
- Usar colores e iconos apropiados por tipo de notificación

window.dispatchEvent(new CustomEvent('orderAssigned', {
detail: { order: {}, message: 'Test', type: 'test' }
}));

```

```
