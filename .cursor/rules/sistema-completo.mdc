---
description:
globs:
alwaysApply: false
---
# Sistema VML Perito - Resumen Completo

## Arquitectura General

### Backend (Node.js + Express + Sequelize)
- **Puerto**: 3001
- **Base de datos**: MySQL
- **Autenticación**: JWT + bcrypt
- **WebSockets**: Socket.io para notificaciones en tiempo real
- **Middleware**: RBAC, rate limiting, helmet, sanitización

### Frontend (React + Vite)
- **Puerto**: 5173
- **UI**: shadcn/ui + Tailwind CSS
- **Estado**: Context API (Auth, RBAC, Notifications)
- **Routing**: React Router con rutas protegidas

## Roles del Sistema

### Administración
- **super_admin**: Administrador principal del sistema
- **admin**: Administrador con permisos limitados

### Operaciones
- **comercial_mundial**: Crea y gestiona órdenes de inspección
- **coordinador_contacto**: Coordinador de Contact Center - supervisa agentes
- **agente_contacto**: Agente de Contact Center - gestiona llamadas y agendamientos

## Flujo de Trabajo Principal

### 1. Creación de Orden (Comercial Mundial)
- **Página**: [ComercialMundial.jsx](mdc:apps/web/src/pages/ComercialMundial.jsx)
- **Modal**: [CreateOrderModal.jsx](mdc:apps/web/src/components/CreateOrderModal.jsx)
- **Proceso**: Cliente → Vehículo → Ubicación → Sede → Crear orden

### 2. Asignación (Coordinador de Contact Center)
- **Página**: [CoordinadorContacto.jsx](mdc:apps/web/src/pages/CoordinadorContacto.jsx)
- **Funciones**: Ver órdenes, asignar agentes, supervisar progreso
- **API**: [coordinadorContactoController.js](mdc:apps/server/controllers/coordinadorContactoController.js)

### 3. Gestión de Llamadas (Agente de Contact Center)
- **Página**: [AgenteContacto.jsx](mdc:apps/web/src/pages/AgenteContacto.jsx)
- **Funciones**: Registrar llamadas, agendar citas, actualizar estados
- **API**: [contactAgentController.js](mdc:apps/server/controllers/contactAgentController.js)

## Sistema de Agendamiento Avanzado

### Modalidades de Inspección
- **En Sede**: Inspección en instalaciones del CDA
- **A Domicilio**: Inspección en domicilio del cliente
- **Virtual**: Inspección remota/virtual

### Tipos de Vehículos
- **Livianos**: Automóviles, camionetas pequeñas
- **Pesados**: Camiones, buses, tractomulas
- **Motos**: Motocicletas y ciclomotores

### Horarios Flexibles
- **Patrones**: Días individuales o rangos (L-V, L-S, etc.)
- **Intervalos**: 30, 60, 90 minutos configurables
- **Capacidad**: Cupos específicos por intervalo de tiempo

## Sedes Configuradas

### CDAs Bogotá
- **CDA 197**: Completo (L-V 7-17, S 8-17) - Todos los vehículos
- **CDA Distrital**: Livianos (L-V 7-17, S 8-17)
- **CDA PREVITAX**: Livianos (L-S 6-18)

### CDAs Cali
- **CDA Cali Norte**: Completo + Domingos (L-V 7-17, S 8-17, D 8-12)
- **CDA Cali Sur**: Livianos y Motos + Domingos (L-V 7-17, S 8-17, D 8-12)

### Sedes Administrativas
- **Sede Comercial Bogotá**: Para usuarios comerciales
- **Sede Soporte Bogotá**: Para contact center

## Sistema de Notificaciones

### Canales Disponibles
- **InApp**: Notificaciones en tiempo real via WebSocket
- **Email**: Notificaciones por correo electrónico
- **SMS**: Mensajes de texto (configurado)
- **WhatsApp**: Mensajes WhatsApp (configurado)
- **Push**: Notificaciones push (configurado)

### Características
- **Persistencia**: Notificaciones guardadas para usuarios desconectados
- **Templates**: Sistema de plantillas con variables dinámicas
- **Programación**: Inmediatas, retrasadas, recurrentes
- **Reintentos**: Sistema con backoff exponencial

## Inicialización del Sistema

### Comandos Principales
```bash
# Configurar base de datos
cd apps/server
FORCE_DB=true npm run setup:db

# Seeding completo
npm run seed

# Iniciar servidor
npm run dev

# Iniciar frontend
cd ../web
npm run dev
```

### Credenciales de Prueba
```
Admin: admin@vmlperito.com / 123456
Comercial: comercial@vmlperito.com / 123456
Coordinadora: coordinadora@vmlperito.com / 123456
Agente 1: agente1@vmlperito.com / 123456
Agente 2: agente2@vmlperito.com / 123456
```

## Archivos Clave

### Configuración
- **Database**: [database.js](mdc:apps/server/config/database.js)
- **API Config**: [api.js](mdc:apps/web/src/config/api.js)
- **RBAC**: [rbac.js](mdc:apps/server/middleware/rbac.js)

### Modelos Principales
- **User**: [user.js](mdc:apps/server/models/user.js)
- **InspectionOrder**: [inspectionOrder.js](mdc:apps/server/models/inspectionOrder.js)
- **Appointment**: [appointment.js](mdc:apps/server/models/appointment.js)
- **ScheduleTemplate**: [scheduleTemplate.js](mdc:apps/server/models/scheduleTemplate.js)

### Controladores
- **Auth**: [authController.js](mdc:apps/server/controllers/authController.js)
- **Orders**: [inspectionOrderController.js](mdc:apps/server/controllers/inspectionOrderController.js)
- **Schedules**: [scheduleController.js](mdc:apps/server/controllers/scheduleController.js)
- **Notifications**: [notificationController.js](mdc:apps/server/controllers/notificationController.js)

### Contextos React
- **Auth**: [auth-context.jsx](mdc:apps/web/src/contexts/auth-context.jsx)
- **RBAC**: [rbac-context.jsx](mdc:apps/web/src/contexts/rbac-context.jsx)
- **Notifications**: [notification-context.jsx](mdc:apps/web/src/contexts/notification-context.jsx)

## Próximas Implementaciones

### Frontend Pendiente
- Selector de tipo de vehículo en formularios
- Grid de horarios disponibles con capacidad
- Validación de disponibilidad en tiempo real
- Dashboard de métricas y reportes

### Backend Pendiente
- Sistema de reportes avanzados
- Integración con APIs externas
- Optimización de consultas complejas
- Sistema de backup automatizado

## Troubleshooting

### Errores Comunes
1. **CORS**: Verificar configuración en index.js
2. **JWT**: Revisar variables de entorno
3. **DB Connection**: Validar credenciales MySQL
4. **Foreign Keys**: Ejecutar seeding en orden correcto

### Logs Importantes
- **Server**: Console logs en desarrollo
- **Database**: Sequelize logging habilitado
- **WebSocket**: Logs de conexiones en tiempo real
