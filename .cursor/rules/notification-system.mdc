---
description:
globs:
alwaysApply: false
---
# Sistema de Notificaciones Transversal

## Arquitectura General

El sistema de notificaciones es **transversal** y maneja m√∫ltiples canales de comunicaci√≥n:

- **In-App**: WebSocket + Base de datos para persistencia
- **Email**: Plantillas HTML con proveedores externos
- **WhatsApp**: Integraci√≥n con Meta API o Twilio
- **SMS**: Servicios de mensajer√≠a con validaci√≥n
- **Push**: Firebase Cloud Messaging (FCM)

## Modelos de Datos

### Modelo Principal
- **[Notification](mdc:apps/server/models/notification.js)**: Almacena todas las notificaciones
- **[NotificationConfig](mdc:apps/server/models/notificationConfig.js)**: Configuraciones y plantillas
- **[NotificationQueue](mdc:apps/server/models/notificationQueue.js)**: Cola de procesamiento
- **[NotificationChannel](mdc:apps/server/models/notificationChannel.js)**: Canales disponibles
- **[NotificationType](mdc:apps/server/models/notificationType.js)**: Tipos de notificaci√≥n

### Estructura de Datos
```javascript
// Notification - Estado completo de una notificaci√≥n
{
    id: number,
    notification_config_id: number,
    recipient_type: 'user' | 'client',
    recipient_user_id: number,
    title: string,
    content: string,
    status: 'pending' | 'scheduled' | 'sending' | 'sent' | 'delivered' | 'failed' | 'read',
    priority: 'low' | 'normal' | 'high' | 'urgent',
    scheduled_at: Date,
    metadata: JSON,
    websocket_delivered: boolean
}
```

## Servicio Central

### NotificationService
**Ubicaci√≥n**: [apps/server/services/notificationService.js](mdc:apps/server/services/notificationService.js)

```javascript
// Crear notificaci√≥n por tipo
await NotificationService.createNotification('orden_creada', {
    order: orderData,
    client: clientData,
    agent: agentData
}, {
    recipient_user_id: userId, // Opcional: destinatario espec√≠fico
    scheduled_at: futureDate   // Opcional: programar env√≠o
});
```

### Patrones de Uso
```javascript
// 1. Notificaci√≥n inmediata a roles espec√≠ficos
await NotificationService.createNotification('orden_asignada', {
    order: { numero: '123456', cliente: 'Juan P√©rez' },
    agent: { name: 'Ana Garc√≠a' }
});

// 2. Notificaci√≥n programada a usuario espec√≠fico
await NotificationService.createNotification('recordatorio_cita', {
    appointment: appointmentData
}, {
    recipient_user_id: clientId,
    scheduled_at: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24h despu√©s
});

// 3. Notificaci√≥n a cliente externo
await NotificationService.createNotification('orden_agendada', {
    order: orderData,
    client: {
        name: order.nombre_contacto,
        phone: order.celular_contacto,
        email: order.correo_contacto
    }
});
```

## Servicios de Canales

### In-App Service
**Ubicaci√≥n**: [apps/server/services/channels/inAppService.js](mdc:apps/server/services/channels/inAppService.js)

- **Integraci√≥n WebSocket**: Usa el sistema WebSocket existente
- **Persistencia**: Almacena en BD para usuarios desconectados
- **Tiempo real**: Notificaciones toast inmediatas

```javascript
// Inicializar con WebSocket system
inAppService.initialize(webSocketSystem);

// Verifica conectividad
const isConnected = inAppService.isUserConnected(userId);
```

### Email Service
**Ubicaci√≥n**: [apps/server/services/channels/emailService.js](mdc:apps/server/services/channels/emailService.js)

- **Templates HTML**: Generaci√≥n autom√°tica de plantillas
- **Proveedores**: Preparado para NodeMailer, SendGrid, etc.
- **Prioridades**: Mapeo de urgencia a headers de email

```javascript
// Configurar proveedor (pendiente implementaci√≥n)
emailService.configureProvider('sendgrid', {
    apiKey: process.env.SENDGRID_API_KEY
});
```

### WhatsApp Service
**Ubicaci√≥n**: [apps/server/services/channels/whatsappService.js](mdc:apps/server/services/channels/whatsappService.js)

- **Formateo**: Mensajes con Markdown para WhatsApp
- **Validaci√≥n**: N√∫meros de tel√©fono colombianos
- **Webhooks**: Manejo de estados de entrega

### SMS Service
**Ubicaci√≥n**: [apps/server/services/channels/smsService.js](mdc:apps/server/services/channels/smsService.js)

- **L√≠mites**: M√°ximo 160 caracteres por mensaje
- **Costos**: C√°lculo estimado por segmentos
- **Formato**: Mensajes optimizados para SMS

### Push Service
**Ubicaci√≥n**: [apps/server/services/channels/pushService.js](mdc:apps/server/services/channels/pushService.js)

- **FCM**: Firebase Cloud Messaging
- **Service Worker**: Notificaciones en navegador
- **Deep Links**: URLs espec√≠ficas por tipo de notificaci√≥n

## Configuraci√≥n de Notificaciones

### Plantillas con Variables
```javascript
// En NotificationConfig
{
    template_title: "Nueva orden asignada: {{order.numero}}",
    template_content: "Hola {{agent.name}}, se te ha asignado la orden {{order.numero}} para el cliente {{order.cliente}}",
    template_variables: {
        "order.numero": "N√∫mero de la orden",
        "order.cliente": "Nombre del cliente",
        "agent.name": "Nombre del agente"
    }
}
```

### Targeting por Roles
```javascript
{
    target_roles: ["coordinador_contacto", "agente_contacto"],
    target_users: [123, 456], // IDs espec√≠ficos
    for_clients: true,         // Para clientes externos
    for_users: true           // Para usuarios del sistema
}
```

### Programaci√≥n
```javascript
{
    schedule_type: "immediate" | "delayed" | "recurring",
    schedule_delay_minutes: 60,        // Para delayed
    schedule_cron: "0 9 * * 1-5"      // Para recurring
}
```

## Controlador de APIs

**Ubicaci√≥n**: [apps/server/controllers/notificationController.js](mdc:apps/server/controllers/notificationController.js)

### Endpoints Principales
```javascript
GET    /api/notifications              // Obtener notificaciones del usuario
POST   /api/notifications/:id/read     // Marcar como le√≠da
POST   /api/notifications/read-all     // Marcar todas como le√≠das
GET    /api/notifications/stats        // Estad√≠sticas
POST   /api/notifications/push-token   // Registrar token push
POST   /api/webhooks/:channel          // Webhooks de proveedores
```

### Formato de Respuesta
```javascript
{
    success: true,
    data: {
        notifications: [
            {
                id: 1,
                title: "Nueva orden asignada",
                description: "Se te ha asignado la orden #123456",
                type: "orden_asignada",
                priority: "normal",
                read: false,
                time: "Hace 5 minutos",
                timestamp: "2024-01-15T10:30:00Z"
            }
        ],
        pagination: {
            total: 25,
            unread_count: 3,
            page: 1,
            pages: 3
        }
    }
}
```

## Integraci√≥n con Sistema Existente

### WebSocket Integration
```javascript
// En index.js del servidor
import NotificationService from './services/notificationService.js';

// Inicializar servicio In-App con WebSocket
const inAppService = NotificationService.channels.in_app;
inAppService.initialize(webSocketSystem);
```

### Uso en Controladores Existentes
```javascript
// En coordinadorContactoController.js
import NotificationService from '../services/notificationService.js';

// Al asignar orden
await NotificationService.createNotification('orden_asignada', {
    order: updatedOrder,
    agent: assignedAgent,
    coordinator: req.user
}, {
    recipient_user_id: agent_id
});
```

## Cola de Procesamiento

### NotificationQueue
- **Procesamiento autom√°tico**: Cada minuto via cron
- **Reintentos**: Exponential backoff para fallos
- **Prioridades**: urgent > high > normal > low
- **Bloqueos**: Previene procesamiento duplicado

### Estados de Cola
```javascript
{
    status: 'pending' | 'processing' | 'completed' | 'failed' | 'cancelled',
    attempts: number,
    next_attempt_at: Date,
    worker_id: string
}
```

## Tipos de Notificaci√≥n Est√°ndar

### Sistema de Inspecciones
- **`orden_creada`**: Nueva orden creada por comercial
- **`orden_asignada`**: Orden asignada a agente
- **`orden_reasignada`**: Orden reasignada a otro agente
- **`orden_removida`**: Orden removida de asignaci√≥n
- **`orden_agendada`**: Inspecci√≥n agendada
- **`recordatorio_cita`**: Recordatorio de cita pr√≥xima

### Configuraci√≥n por Tipo
```javascript
// orden_asignada
{
    channels: ['in_app', 'email'],
    target_roles: [], // Vac√≠o porque es espec√≠fica
    priority: 'high',
    schedule_type: 'immediate'
}

// orden_agendada  
{
    channels: ['sms', 'whatsapp', 'email'],
    for_clients: true,
    priority: 'normal',
    schedule_type: 'immediate'
}
```

## Debugging y Logs

### Logs Est√°ndar
```javascript
console.log('üì¨ Creando notificaci√≥n tipo: orden_asignada');
console.log('üì± Enviando In-App a usuario 123');
console.log('üìß Enviando email a: user@example.com');
console.log('‚úÖ Notificaci√≥n enviada: ID 456 via in_app');
```

### Monitoreo
- **Estados**: Tracking completo de cada notificaci√≥n
- **Reintentos**: Log de intentos fallidos
- **M√©tricas**: Estad√≠sticas por canal y tipo
- **Webhooks**: Log de respuestas de proveedores

## Mejores Pr√°cticas

### 1. Creaci√≥n de Notificaciones
```javascript
// ‚úÖ Bueno: Datos estructurados
await NotificationService.createNotification('orden_asignada', {
    order: { id, numero, cliente },
    agent: { id, name, email }
});

// ‚ùå Malo: Datos incompletos
await NotificationService.createNotification('orden_asignada', {
    orderId: 123
});
```

### 2. Manejo de Errores
```javascript
try {
    await NotificationService.createNotification(type, data);
} catch (error) {
    console.error('Error creando notificaci√≥n:', error);
    // No fallar el proceso principal por notificaciones
}
```

### 3. Plantillas
```javascript
// ‚úÖ Bueno: Variables claras
"Orden {{order.numero}} asignada a {{agent.name}}"

// ‚ùå Malo: Variables confusas  
"Orden {{numero}} asignada a {{nombre}}"
```

### 4. Programaci√≥n
```javascript
// ‚úÖ Bueno: Usar opciones para scheduling
await NotificationService.createNotification('recordatorio', data, {
    scheduled_at: appointmentDate - (24 * 60 * 60 * 1000) // 24h antes
});

// ‚ùå Malo: Hardcodear delays en configuraci√≥n
```
