# Sistema de Notificaciones - Movilidad Mundial

## üéØ Estado Actual: PRODUCCI√ìN READY (2024)

El sistema de notificaciones est√° **completamente implementado y validado**. Todas las funcionalidades est√°n operativas y las notificaciones se env√≠an autom√°ticamente sin duplicaciones.

### ‚úÖ Funcionalidades Validadas
- **Sistema de eventos autom√°ticos** - Funcionando sin duplicados
- **M√∫ltiples canales** - Email, SMS, WhatsApp, In-App, Push
- **Editor de plantillas** - WYSIWYG con Monaco Editor
- **Sistema de permisos** - RBAC completo
- **WebSocket** - Notificaciones en tiempo real
- **Interfaz de administraci√≥n** - Integrada en [Admin.jsx](mdc:apps/web/src/pages/Admin.jsx)

### üîß Problemas Resueltos
- **Duplicaci√≥n de Notificaciones**: Solucionado con deduplicaci√≥n en `notificationService.js`
- **Listeners Antiguos**: Limpiados con `cleanupOldListeners.js`
- **WebSocket Duplicaci√≥n**: Identificado en `notificationHandler.js`
- **Condiciones de Evaluaci√≥n**: Simplificadas para frontend-friendly

## üèóÔ∏è Arquitectura Completa

### **Backend (Node.js/Express)**
```javascript
// Servicios principales
import eventService from './services/eventService.js';
import notificationService from './services/notificationService.js';
import templateService from './services/templateService.js';
import automatedEventTriggers from './services/automatedEventTriggers.js';
```

### **Frontend (React)**
```javascript
// Componentes principales
import { NotificationTemplateEditor } from '@/components/NotificationTemplateEditor';
import { ChannelPreview } from '@/components/ChannelPreview';
import { useNotificationContext } from '@/contexts/notification-context';
```

## üîÑ Flujo de Notificaciones

### **1. Creaci√≥n de Orden de Inspecci√≥n**
```javascript
// En InspectionOrderController.store()
await automatedEventTriggers.triggerInspectionOrderEvents('created', orderData, context);
```

### **2. Evento Disparado**
- Evento: `inspection_order.created`
- Listener: Busca tipo `order_created_commercial_email`
- Canales: Email + In-App + Push

### **3. Notificaci√≥n Enviada**
- Plantilla renderizada con variables
- Env√≠o por canales configurados
- Logs de confirmaci√≥n

## üìã Campos Estandarizados

### **Backend (Primary)**
```javascript
{
  title: "T√≠tulo de notificaci√≥n",
  content: "Contenido principal",
  metadata: {
    channel_data: {
      email: { subject: "...", body: "..." },
      sms: { message: "..." },
      whatsapp: { message: "...", title: "..." }
    }
  }
}
```

### **Frontend (Editor)**
```javascript
{
  channels: {
    email: { template: "...", message: "...", body: "...", html: "...", text: "...", title: "..." },
    sms: { template: "...", message: "..." },
    whatsapp: { template: "...", message: "...", title: "..." }
  }
}
```

## üõ†Ô∏è Patrones Clave

### **Find or Create (Prevenci√≥n de Duplicados)**
```javascript
// ‚úÖ Correct: Siempre usar find or create
const result = await this.findOrCreateEvent(eventName, description, category);
if (result.created) {
  console.log('‚úÖ Event created');
} else {
  console.log('‚è≠Ô∏è Event already exists');
}
```

### **Event Triggering (Controladores)**
```javascript
// ‚úÖ Correct: Usar AutomatedEventTriggers
await automatedEventTriggers.triggerUserEvents('created', userData, context);
await automatedEventTriggers.triggerInspectionOrderEvents('created', orderData, context);
await automatedEventTriggers.triggerAppointmentEvents('created', appointmentData, context);
```

### **Method Binding (Controladores)**
```javascript
// ‚úÖ Correct: Bind methods en constructor
constructor() {
  super(Model);
  this.index = this.index.bind(this);
  this.store = this.store.bind(this);
  this.update = this.update.bind(this);
  this.destroy = this.destroy.bind(this);
}
```

## üìä Configuraci√≥n de Listeners

### **Listeners Granulares (seedAdvancedListeners.js)**
```javascript
// Ejemplo: Email para comercial
{
  event_name: 'inspection_order.created',
  notification_type_name: 'order_created_commercial_email',
  conditions: { user_role: 'comercial_mundial' },
  priority: 1,
  delay_seconds: 0,
  channels: ['email']
}
```

### **Plantillas Espec√≠ficas (seedAdvancedTemplates.js)**
```javascript
// Ejemplo: Plantilla de email para comercial
{
  name: 'order_created_commercial_email',
  description: 'Email de notificaci√≥n de orden creada para comercial',
  channels: {
    email: {
      subject: 'Nueva Orden de Inspecci√≥n Creada',
      template: 'Hola {{user.name}}, se ha creado una nueva orden de inspecci√≥n...'
    }
  }
}
```

## üîß Debugging y Troubleshooting

### **Verificar Estado del Sistema**
```javascript
// Obtener estad√≠sticas del sistema
const stats = await automatedEventTriggers.getStats();
console.log('üìä System stats:', JSON.stringify(stats, null, 2));

// Verificar listeners activos
const listeners = await eventService.getEventListeners('inspection_order.created');
console.log(`üìä Listeners for inspection_order.created: ${listeners.length}`);
```

### **Scripts de Limpieza**
```bash
# Limpiar listeners duplicados
cd apps/server && node scripts/cleanupOldListeners.js

# Probar sistema completo
cd apps/server && node scripts/testNotificationSystem.js
```

### **Logs de Debugging**
```javascript
// ‚úÖ Correct: Comprehensive logging
console.log('üéØ Event triggered:', eventName);
console.log('üì¨ Creating notification type:', notificationType);
console.log('üì§ Notification sent by listener:', listenerId);
console.log('‚ö†Ô∏è No active configurations for:', notificationType);
```

## üé® Interfaz de Administraci√≥n

### **Integraci√≥n en Admin.jsx**
```javascript
// Nueva pesta√±a de notificaciones
<TabsTrigger value="notifications" className="flex items-center gap-2">
  <Bell className="h-4 w-4" />
  Notificaciones
</TabsTrigger>

// Contenido de la pesta√±a
<TabsContent value="notifications" className="space-y-6">
  {/* Estad√≠sticas, Configuraciones, Logs */}
</TabsContent>
```

### **Componentes Principales**
- **NotificationTemplateEditor**: Editor WYSIWYG de plantillas
- **ChannelPreview**: Vista previa por canal
- **NotificationAdmin**: Gesti√≥n de configuraciones
- **ChannelConfigurations**: Configuraci√≥n de canales

## üìÅ Archivos Cr√≠ticos

### **Backend**
- [apps/server/services/eventService.js](mdc:apps/server/services/eventService.js) - Evaluaci√≥n de condiciones
- [apps/server/services/notificationService.js](mdc:apps/server/services/notificationService.js) - Deduplicaci√≥n
- [apps/server/services/automatedEventTriggers.js](mdc:apps/server/services/automatedEventTriggers.js) - Disparo de eventos
- [apps/server/scripts/seedAdvancedListeners.js](mdc:apps/server/scripts/seedAdvancedListeners.js) - Listeners granulares
- [apps/server/scripts/seedAdvancedTemplates.js](mdc:apps/server/scripts/seedAdvancedTemplates.js) - Plantillas espec√≠ficas

### **Frontend**
- [apps/web/src/pages/Admin.jsx](mdc:apps/web/src/pages/Admin.jsx) - Interfaz de administraci√≥n
- [apps/web/src/components/NotificationTemplateEditor.jsx](mdc:apps/web/src/components/NotificationTemplateEditor.jsx) - Editor de plantillas
- [apps/web/src/contexts/notification-context.jsx](mdc:apps/web/src/contexts/notification-context.jsx) - Contexto de notificaciones

### **Documentaci√≥n**
- [todo/seeders_adjustment.md](mdc:todo/seeders_adjustment.md) - Configuraci√≥n de seeders
- [docs/notification_standards.md](mdc:docs/notification_standards.md) - Est√°ndares backend
- [docs/frontend_notification_standards.md](mdc:docs/frontend_notification_standards.md) - Est√°ndares frontend

## üîó Integraci√≥n con Otros Sistemas

### **WebSockets**
- Sistema de tiempo real para notificaciones in-app
- Integraci√≥n con `notificationHandler.js`
- Eventos: `notification`, `newNotification`

### **RBAC**
- Permisos para gesti√≥n de notificaciones
- Roles: `super_admin`, `admin`
- Rutas protegidas en [App.jsx](mdc:apps/web/src/App.jsx)

### **Webhooks** (Planificado)
- Sistema de webhooks para plataformas externas
- Integraci√≥n con interfaz de administraci√≥n
- Documentaci√≥n en [todo/webhook_notificaciones.md](mdc:todo/webhook_notificaciones.md)

## üöÄ Mejores Pr√°cticas

### **1. Prevenci√≥n de Duplicaciones**
- Usar siempre patr√≥n "find or create"
- Implementar deduplicaci√≥n en `notificationService.js`
- Limpiar listeners antiguos regularmente

### **2. Validaci√≥n de Datos**
- Validar plantillas antes de guardar
- Verificar variables disponibles
- Sanitizar contenido de notificaciones

### **3. Performance**
- Usar procesamiento as√≠ncrono
- Implementar rate limiting
- Optimizar queries de base de datos

### **4. Seguridad**
- Validar permisos RBAC
- Sanitizar datos de entrada
- Logging de auditor√≠a completo

## Related Rules

- [webhook-system.mdc](mdc:.cursor/rules/webhook-system.mdc) - Sistema de webhooks
- [backend-development-patterns.mdc](mdc:.cursor/rules/backend-development-patterns.mdc) - Patrones backend
- [frontend-development-patterns.mdc](mdc:.cursor/rules/frontend-development-patterns.mdc) - Patrones frontend
- [debugging-and-troubleshooting.mdc](mdc:.cursor/rules/debugging-and-troubleshooting.mdc) - Debugging
- [vml-perito-system.mdc](mdc:.cursor/rules/vml-perito-system.mdc) - Sistema principal
description:
globs:
alwaysApply: false
---
