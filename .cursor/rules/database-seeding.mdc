---
description:
globs:
alwaysApply: false
---
# Database Seeding Patterns

## Seeding Architecture

The application uses multiple seeding scripts for different data types:

- **seedRBAC.js**: Roles, permissions, and role-permission assignments
- **seedUsers.js**: User accounts with role assignments
- **seedData.js**: Master data (departments, cities, companies, sedes)
- **seedInspectionData.js**: Inspection-related data (statuses, types, call statuses)
- **seedAll.js**: Orchestrates all seeding scripts

## Common Seeding Issues and Solutions

### 1. Environment File Path Issues

**Problem**: Scripts in subdirectories can't find .env file
```javascript
// ‚ùå This fails from /scripts subdirectory
require('dotenv').config();
```

**Solution**: Use path.join to locate .env correctly
```javascript
// ‚úÖ Correct approach
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config({ path: path.join(__dirname, '../.env') });
```

### 2. ES Module vs CommonJS

**Problem**: Package.json has `"type": "module"` but scripts use require()
```javascript
// ‚ùå This fails with ES modules
const { sequelize } = require('./models');
```

**Solution**: Use ES module imports
```javascript
// ‚úÖ Correct ES module syntax
import sequelize from '../config/database.js';
import { User, Role } from '../models/index.js';
```

### 3. Database Connection Errors

**Problem**: ConnectionRefusedError or ETIMEDOUT
```javascript
// Common connection issues:
// - MySQL server not running
// - Incorrect credentials
// - Network timeouts
```

**Solution**: Verify connection and add error handling
```javascript
try {
    await sequelize.authenticate();
    console.log('‚úÖ Database connection established');
} catch (error) {
    console.error('‚ùå Database connection failed:', error.message);
    process.exit(1);
}
```

## Seeding Script Pattern

### Standard Script Structure
```javascript
import 'dotenv/config';
import path from 'path';
import { fileURLToPath } from 'url';
import sequelize from '../config/database.js';
import { Model1, Model2 } from '../models/index.js';

// Fix .env path for subdirectory scripts
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
dotenv.config({ path: path.join(__dirname, '../.env') });

async function seedFunction() {
    try {
        console.log('üå± Starting seeding process...');
        
        // Connect to database
        await sequelize.authenticate();
        console.log('‚úÖ Database connected');
        
        // Sync models (optional)
        await sequelize.sync();
        console.log('‚úÖ Models synchronized');
        
        // Check if data already exists
        const existingCount = await Model1.count();
        if (existingCount > 0) {
            console.log('üìä Data already exists, skipping...');
            return;
        }
        
        // Seed data
        const seedData = [
            { name: 'Item 1', description: 'Description 1' },
            { name: 'Item 2', description: 'Description 2' }
        ];
        
        await Model1.bulkCreate(seedData);
        console.log(`‚úÖ Created ${seedData.length} records`);
        
    } catch (error) {
        console.error('‚ùå Seeding failed:', error);
        throw error;
    } finally {
        await sequelize.close();
        console.log('üîå Database connection closed');
    }
}

// Execute if called directly
if (import.meta.url === `file://${process.argv[1]}`) {
    seedFunction();
}

export default seedFunction;
```

## RBAC Seeding Pattern

### Role and Permission Creation
```javascript
// Create roles first
const roles = [
    { name: 'admin', description: 'Administrator' },
    { name: 'coordinador_contacto', description: 'Contact Coordinator' },
    { name: 'agente_contacto', description: 'Contact Agent' },
    { name: 'comercial_mundial', description: 'Global Commercial' }
];

const createdRoles = await Role.bulkCreate(roles, {
    updateOnDuplicate: ['description']
});

// Create permissions
const permissions = [
    { name: 'coordinador_contacto.read', description: 'View coordinator dashboard' },
    { name: 'coordinador_contacto.assign', description: 'Assign agents to orders' },
    { name: 'agente_contacto.read', description: 'View assigned orders' },
    { name: 'agente_contacto.call', description: 'Log calls' }
];

const createdPermissions = await Permission.bulkCreate(permissions, {
    updateOnDuplicate: ['description']
});

// Assign permissions to roles
const rolePermissions = [
    { role_name: 'coordinador_contacto', permission_name: 'coordinador_contacto.read' },
    { role_name: 'coordinador_contacto', permission_name: 'coordinador_contacto.assign' },
    { role_name: 'agente_contacto', permission_name: 'agente_contacto.read' },
    { role_name: 'agente_contacto', permission_name: 'agente_contacto.call' }
];

for (const rp of rolePermissions) {
    const role = await Role.findOne({ where: { name: rp.role_name } });
    const permission = await Permission.findOne({ where: { name: rp.permission_name } });
    
    if (role && permission) {
        await RolePermission.findOrCreate({
            where: { role_id: role.id, permission_id: permission.id }
        });
    }
}
```

## User Seeding Pattern

### User Creation with Role Assignment
```javascript
const users = [
    {
        name: 'Ana Coordinadora',
        email: 'coordinadora@vmlperito.com',
        password: '123456',
        roles: ['coordinador_contacto']
    },
    {
        name: 'Laura Agente',
        email: 'agente1@vmlperito.com',
        password: '123456',
        roles: ['agente_contacto']
    }
];

for (const userData of users) {
    // Create user
    const [user, created] = await User.findOrCreate({
        where: { email: userData.email },
        defaults: {
            name: userData.name,
            email: userData.email,
            password: await bcrypt.hash(userData.password, 10),
            is_active: true
        }
    });
    
    if (created) {
        console.log(`‚úÖ Created user: ${user.name}`);
    }
    
    // Assign roles
    for (const roleName of userData.roles) {
        const role = await Role.findOne({ where: { name: roleName } });
        if (role) {
            await UserRole.findOrCreate({
                where: { user_id: user.id, role_id: role.id }
            });
        }
    }
}
```

## Master Data Seeding Pattern

### Hierarchical Data Creation
```javascript
// Create departments first
const departments = [
    { name: 'Bogot√° D.C.', code: 'BOG' },
    { name: 'Antioquia', code: 'ANT' }
];

const createdDepartments = await Department.bulkCreate(departments, {
    updateOnDuplicate: ['name']
});

// Create cities with department references
const cities = [
    { name: 'Bogot√°', code: 'BOG001', department_name: 'Bogot√° D.C.' },
    { name: 'Medell√≠n', code: 'MED001', department_name: 'Antioquia' }
];

for (const cityData of cities) {
    const department = await Department.findOne({ 
        where: { name: cityData.department_name } 
    });
    
    if (department) {
        await City.findOrCreate({
            where: { code: cityData.code },
            defaults: {
                name: cityData.name,
                code: cityData.code,
                department_id: department.id
            }
        });
    }
}
```

## Orchestration Pattern

### Master Seeding Script
```javascript
// seedAll.js
import seedRBAC from './seedRBAC.js';
import seedUsers from './seedUsers.js';
import seedData from './seedData.js';
import seedInspectionData from './seedInspectionData.js';

async function seedAll() {
    try {
        console.log('üå± Starting complete database seeding...');
        
        // Seed in correct order (dependencies first)
        await seedRBAC();
        await seedData();
        await seedInspectionData();
        await seedUsers(); // Users last (depend on roles and sedes)
        
        console.log('‚úÖ All seeding completed successfully!');
        
    } catch (error) {
        console.error('‚ùå Seeding failed:', error);
        process.exit(1);
    }
}

seedAll();
```

## Running Seeds

### Command Line Usage
```bash
# Run all seeds
node scripts/seedAll.js

# Run specific seed
node scripts/seedRBAC.js
node scripts/seedUsers.js

# Run from package.json scripts
npm run seed
npm run seed:rbac
```

## Troubleshooting Common Issues

### 1. Foreign Key Constraints
```javascript
// Ensure parent records exist before creating children
const department = await Department.findOne({ where: { name: 'Bogot√° D.C.' } });
if (!department) {
    throw new Error('Department not found - run seedData first');
}
```

### 2. Unique Constraint Violations
```javascript
// Use findOrCreate instead of create for unique fields
const [user, created] = await User.findOrCreate({
    where: { email: userData.email },
    defaults: userData
});
```

### 3. Model Sync Issues
```javascript
// Force sync in development only
if (process.env.NODE_ENV === 'development') {
    await sequelize.sync({ force: true });
}
```
